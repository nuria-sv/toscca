lv$K1 = scale_rm(lv[,c("id", "time", "K1")], centre = T)$K1; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K1 = lvplot$K1), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p1 = plot_ly(lvplot, x = ~time, y = ~K1, color = ~Class, type = 'scatter',mode = 'markers+lines', split = ~id) %>%
layout(
title = paste0("RNA latent path for K1"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K1")
)
)
lv = get(paste0("lv_b_", type, "_", substr(level, 1, 3)))
lv$K1 = scale_rm(lv[,c("id", "time", "K1")], centre = T)$K1; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K1 = lvplot$K1), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p2 = plot_ly(lvplot, x = ~time, y = ~K1, color = ~Class, type = 'scatter', mode = 'markers+lines', split = ~id) %>%
layout(
title =  paste0("Latent paths for K1"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K1")
)
)
assign(paste0("plot_lv_a_", substr(level, 1, 3)), p1); rm(p1)
assign(paste0("plot_lv_b_", substr(level, 1, 3)), p2); rm(p2)
}
lv = get(paste0("lv_a_", type, "_", substr(level, 1, 3)))
lv$K1 = scale_rm(lv[,c("id", "time", "K1")], centre = T)$K1; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K1 = lvplot$K1), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p1 = plot_ly(lvplot, x = ~time, y = ~K1, color = ~Class, type = 'scatter',mode = 'markers+lines', split = ~id) %>%
layout(
title = paste0("RNA latent path for K1"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K1")
)
)
p1
lv = get(paste0("lv_b_", type, "_", substr(level, 1, 3)))
lv$K1 = scale_rm(lv[,c("id", "time", "K1")], centre = T)$K1; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K1 = lvplot$K1), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
lv$K1
par(mfrow=c(1,2))
for (level in level_str) {
# dev.new(
lv = get(paste0("lv_a_", type, "_", substr(level, 1, 3)))
lv$K1 = scale_rm(lv[,c("id", "time", "K1")], centre = T)$K1; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K1 = lvplot$K1), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p1 = plot_ly(lvplot, x = ~time, y = ~K1, color = ~Class, type = 'scatter',mode = 'markers+lines', split = ~id) %>%
layout(
title = paste0("RNA latent path for K1"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K1")
)
)
lv = get(paste0("lv_b_", type, "_", substr(level, 1, 3)))
lv$K1 = scale_rm(lv[,c("id", "time", "K1")], centre = T)$K1; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K1 = lvplot$K1), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p2 = plot_ly(lvplot, x = ~time, y = ~K1, color = ~Class, type = 'scatter', mode = 'markers+lines', split = ~id) %>%
layout(
title =  paste0("Latent paths for K1"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K1")
)
)
assign(paste0("plot_lv_a_", substr(level, 1, 3)), p1); rm(p1)
assign(paste0("plot_lv_b_", substr(level, 1, 3)), p2); rm(p2)
}
#
# subplot(style(plot_lv_a_gen, showlegend = F), plot_lv_b_gen)
# subplot(style(plot_lv_a_fam, showlegend = F), plot_lv_b_fam)
# subplot(style(plot_lv_a_ord, showlegend = F), plot_lv_b_ord)
# subplot(style(plot_lv_a_cla, showlegend = F), plot_lv_b_cla)
# subplot(style(plot_lv_a_phy, showlegend = F), plot_lv_b_phy)
plot_all_k1 = subplot(style(plot_lv_a_gen, showlegend = F), style(plot_lv_b_gen, showlegend = F),
style(plot_lv_a_fam, showlegend = F), style(plot_lv_b_fam, showlegend = F),
style(plot_lv_a_ord, showlegend = F), style(plot_lv_b_ord, showlegend = F),
style(plot_lv_a_cla, showlegend = F), style(plot_lv_b_cla, showlegend = F),
style(plot_lv_a_phy, showlegend = F), style(plot_lv_b_phy, showlegend = T), nrows = 5)
plot_all_k1 <- plot_all_k1 %>% layout(
annotations = list(
list(x = 0.1, y = 1.02, text = "RNA - genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 1.02, text = "Gut  -genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.82, text = "RNA - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.82, text = "Gut - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.62, text = "RNA - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.62, text = "Gut - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.42, text = "RNA - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.42, text = "Gut - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.22, text = "RNA - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.22, text = "Gut - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper')
)
)
for (level in level_str[1:4]) {
# dev.new(
lv = get(paste0("lv_a_", type, "_", substr(level, 1, 3)))
lv$K2 = scale_rm(lv[,c("id", "time", "K2")], centre = T)$K2; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K2 = lvplot$K2), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p1 = plot_ly(lvplot, x = ~time, y = ~K2, color = ~Class, type = 'scatter',mode = 'markers+lines', split = ~id) %>%
layout(
title = paste0("RNA latent path for K2"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K2")
)
)
lv = get(paste0("lv_b_", type, "_", substr(level, 1, 3)))
lv$K2 = scale(lv$K2) #scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K2 = lvplot$K2), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p2 = plot_ly(lvplot, x = ~time, y = ~K2, color = ~Class, type = 'scatter', mode = 'markers+lines', split = ~id) %>%
layout(
title =  paste0("Latent paths for K2"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K2")
)
)
assign(paste0("plot_lv_a_", substr(level, 1, 3)), p1); rm(p1)
assign(paste0("plot_lv_b_", substr(level, 1, 3)), p2); rm(p2)
}
#
# subplot(style(plot_lv_a_gen, showlegend = F), plot_lv_b_gen)
# subplot(style(plot_lv_a_fam, showlegend = F), plot_lv_b_fam)
# subplot(style(plot_lv_a_ord, showlegend = F), plot_lv_b_ord)
# subplot(style(plot_lv_a_cla, showlegend = F), plot_lv_b_cla)
# subplot(style(plot_lv_a_phy, showlegend = F), plot_lv_b_phy)
plot_all_k2 = subplot(style(plot_lv_a_gen, showlegend = F), style(plot_lv_b_gen, showlegend = F),
style(plot_lv_a_fam, showlegend = F), style(plot_lv_b_fam, showlegend = F),
style(plot_lv_a_ord, showlegend = F), style(plot_lv_b_ord, showlegend = F),
style(plot_lv_a_cla, showlegend = F), style(plot_lv_b_cla, showlegend = T), nrows = 4)
plot_all_k2 <- plot_all_k2 %>% layout(
annotations = list(
list(x = 0.1, y = 1.02, text = "RNA - genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 1.02, text = "Gut  -genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.82, text = "RNA - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.82, text = "Gut - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.62, text = "RNA - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.62, text = "Gut - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.42, text = "RNA - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.42, text = "Gut - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.22, text = "RNA - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.22, text = "Gut - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper')
)
)
plot_all_k1; plot_all_k2
plot_lv_a_phy
type = "predDB"
par(mfrow=c(1,2))
for (level in level_str) {
# dev.new(
lv = get(paste0("lv_a_", type, "_", substr(level, 1, 3)))
lv$K1 = scale_rm(lv[,c("id", "time", "K1")], centre = T)$K1; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K1 = lvplot$K1), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p1 = plot_ly(lvplot, x = ~time, y = ~K1, color = ~Class, type = 'scatter',mode = 'markers+lines', split = ~id) %>%
layout(
title = paste0("RNA latent path for K1"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K1")
)
)
lv = get(paste0("lv_b_", type, "_", substr(level, 1, 3)))
lv$K1 = scale_rm(lv[,c("id", "time", "K1")], centre = T)$K1; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K1 = lvplot$K1), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p2 = plot_ly(lvplot, x = ~time, y = ~K1, color = ~Class, type = 'scatter', mode = 'markers+lines', split = ~id) %>%
layout(
title =  paste0("Latent paths for K1"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K1")
)
)
assign(paste0("plot_lv_a_", substr(level, 1, 3)), p1); rm(p1)
assign(paste0("plot_lv_b_", substr(level, 1, 3)), p2); rm(p2)
}
#
# subplot(style(plot_lv_a_gen, showlegend = F), plot_lv_b_gen)
# subplot(style(plot_lv_a_fam, showlegend = F), plot_lv_b_fam)
# subplot(style(plot_lv_a_ord, showlegend = F), plot_lv_b_ord)
# subplot(style(plot_lv_a_cla, showlegend = F), plot_lv_b_cla)
# subplot(style(plot_lv_a_phy, showlegend = F), plot_lv_b_phy)
plot_all_k1 = subplot(style(plot_lv_a_gen, showlegend = F), style(plot_lv_b_gen, showlegend = F),
style(plot_lv_a_fam, showlegend = F), style(plot_lv_b_fam, showlegend = F),
style(plot_lv_a_ord, showlegend = F), style(plot_lv_b_ord, showlegend = F),
style(plot_lv_a_cla, showlegend = F), style(plot_lv_b_cla, showlegend = F),
style(plot_lv_a_phy, showlegend = F), style(plot_lv_b_phy, showlegend = T), nrows = 5)
plot_all_k1 <- plot_all_k1 %>% layout(
annotations = list(
list(x = 0.1, y = 1.02, text = "RNA - genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 1.02, text = "Gut  -genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.82, text = "RNA - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.82, text = "Gut - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.62, text = "RNA - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.62, text = "Gut - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.42, text = "RNA - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.42, text = "Gut - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.22, text = "RNA - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.22, text = "Gut - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper')
)
)
for (level in level_str[1:4]) {
# dev.new(
lv = get(paste0("lv_a_", type, "_", substr(level, 1, 3)))
lv$K2 = scale_rm(lv[,c("id", "time", "K2")], centre = T)$K2; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K2 = lvplot$K2), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p1 = plot_ly(lvplot, x = ~time, y = ~K2, color = ~Class, type = 'scatter',mode = 'markers+lines', split = ~id) %>%
layout(
title = paste0("RNA latent path for K2"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K2")
)
)
lv = get(paste0("lv_b_", type, "_", substr(level, 1, 3)))
lv$K2 = scale(lv$K2) #scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K2 = lvplot$K2), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p2 = plot_ly(lvplot, x = ~time, y = ~K2, color = ~Class, type = 'scatter', mode = 'markers+lines', split = ~id) %>%
layout(
title =  paste0("Latent paths for K2"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K2")
)
)
assign(paste0("plot_lv_a_", substr(level, 1, 3)), p1); rm(p1)
assign(paste0("plot_lv_b_", substr(level, 1, 3)), p2); rm(p2)
}
#
# subplot(style(plot_lv_a_gen, showlegend = F), plot_lv_b_gen)
# subplot(style(plot_lv_a_fam, showlegend = F), plot_lv_b_fam)
# subplot(style(plot_lv_a_ord, showlegend = F), plot_lv_b_ord)
# subplot(style(plot_lv_a_cla, showlegend = F), plot_lv_b_cla)
# subplot(style(plot_lv_a_phy, showlegend = F), plot_lv_b_phy)
plot_all_k2 = subplot(style(plot_lv_a_gen, showlegend = F), style(plot_lv_b_gen, showlegend = F),
style(plot_lv_a_fam, showlegend = F), style(plot_lv_b_fam, showlegend = F),
style(plot_lv_a_ord, showlegend = F), style(plot_lv_b_ord, showlegend = F),
style(plot_lv_a_cla, showlegend = F), style(plot_lv_b_cla, showlegend = T), nrows = 4)
plot_all_k2 <- plot_all_k2 %>% layout(
annotations = list(
list(x = 0.1, y = 1.02, text = "RNA - genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 1.02, text = "Gut  -genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.82, text = "RNA - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.82, text = "Gut - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.62, text = "RNA - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.62, text = "Gut - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.42, text = "RNA - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.42, text = "Gut - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.22, text = "RNA - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.22, text = "Gut - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper')
)
)
plot_all_k1; plot_all_k2
plot_lv_a_phy
plot_lv_b_phy
plot_all_k1; plot_all_k2
plot_lv_b_phy
plot_all_k1; plot_all_k2
plot_lv_b_phy
knitr::opts_chunk$set(echo = TRUE, fig.width = 12, fig.height = 8)
library(kableExtra)
# data shape -------------------------------------------------------------------
library(readxl)
library(reshape2)
# plots ------------------------------------------------------------------------
library(igraph)
library(ggraph)
library(tidyverse)
library(viridis)
library(RColorBrewer)
library(scales)
library(extrafont)     # for letter fonts
extrafont::loadfonts(device = "win") # load font from extrafont
library(ggplot2)
library(plotly)        # cluster plots
# functions --------------------------------------------------------------------
source("C:/Users/PC/OneDrive/github/sccamm/functions/scale_functions.R")
source("C:/Users/PC/OneDrive/github/sccamm/functions/toscca/toscca_me_ar_folds_CORE.R")
source("C:/Users/PC/OneDrive/github/sccamm/functions/toscca/toscca_me_ar_folds.R")
makeplots = function(X, Y, resx, lmeformule=NA, weigths=TRUE, loadings=TRUE, change=TRUE, scale = FALSE, nonz = "", model = c("arima", "lme"), i = 1) {
if (is.na(lmeformule)) {lmeformule=" ~ time + (1|id)"}
library(lme4)
cv_a = resx$a
cv_b = resx$b
if(scale == TRUE) {cv_a = scalar1(cv_a)}
if(scale == TRUE) {cv_b = scalar1(cv_b)}
if(weigths) {
# dev.new()
# par(mfrow=c(1,2))
plot(1:length(cv_a),cv_a, xlab="variable number", ylab="weights of X-variables")
abline(h=0)
plot(1:length(cv_b),cv_b, xlab="variable number", ylab="weights of Y-variables")
abline(h=0)
title("canonical weights", sub = paste0("sparsity levels (", nonz[1], ", ", nonz[2], ")"), outer=T, line=-3, adj = 0.15)
}
theta = (as.matrix(X[,-c(1,2)]) %*% cv_a);
xi = (as.matrix(Y[,-c(1,2)]) %*%cv_b);
if(loadings) {
# dev.new()
# par(mfrow=c(1,2))
plot(1:length(cv_a) , cor(X[,-c(1,2)], as.numeric(theta)), xlab="variable number", ylab="loadings of X-variables on theta")
abline(h=0)
plot(1:length(cv_b) , cor(Y[,-c(1,2)], as.numeric(xi))   , xlab="variable number", ylab="loadings of Y-variables on xi")
abline(h=0)
title("correlations", sub =paste0("sparsity levels (", nonz[1], ", ", nonz[2], ")"), outer=T, line=-3, adj = 0.5)
}
if(change) {
# dev.new()
rangorde = order(X[,"time"], X[,"id"])
X=X[rangorde,]
id = X[,"id"]
time = X[,"time"]
# ff1 = aggregate(theta, by=list(time), FUN=mean)
# ff3 = lmer(as.formula(paste("theta", lmeformule)))
# ff4 = predict(ff3, newdata=data.frame(time=sort(unique(time)), id=-1), re.form=NA, allow.new.levels=TRUE)
# par(mfrow=c(1,2))
ff1 = aggregate(theta, by=list(time), FUN=mean)
if(model == "arima") {
ff3 = list()
ff4 = matrix(NA, nrow(theta), 1)
for (n in unique(id)) {
ff3[[n]] = arima(theta[n == id], order = arimaorder(resx$me_x[[1]]), method = "ML")
ff4[which(id ==n)] = as.numeric(predict(ff3[[n]], n.ahead = length(time[which(id == n)]))$pred)
}
ff4 = aggregate(ff4, by = list(time), FUN = mean)$V1
if(scale == TRUE) ff4 = scalar1(ff4)
}
if(model == "lme") {
ff3 = lmer(as.formula(paste("theta", lmeformule)), data = data.frame(X))
ff4 = predict(ff3, newdata=data.frame(time=sort(unique(time)), id=-1), re.form=NA, allow.new.levels=TRUE)
}
plot(ff1[,1], ff1[,2], type="b", xlab="time-point", ylab="mean of the latent variable of the X-variables", ylim=c(min(ff1[,2],ff4),max(ff1[,2],ff4)))
lines(sort(unique(time)), ff4, col=2, lwd=2)
rangorde = order(Y[,"time"], Y[,"id"])
Y=Y[rangorde,]
id = Y[,"id"]
time = Y[,"time"]
ff2 = aggregate(xi, by=list(time), FUN=mean)
if(model == "arima") {
ff5 = list()
ff6 = matrix(NA, nrow(xi), 1)
for (n in unique(id)) {
ff5[[n]] = arima(xi[n == id], order = arimaorder(resx$me_y[[1]]), method = "ML")
ff6[which(id ==n)] = as.numeric(predict(ff5[[n]], n.ahead = length(time[which(id == n)]))$pred)
}
ff6 = aggregate(ff6, by = list(time), FUN = mean)$V1
if(scale == TRUE) ff6 = scalar1(ff6)
}
if(model == "lme") {
ff5 = lmer(as.formula(paste("xi", lmeformule)), data = data.frame(Y))
ff6 = predict(ff5, newdata=data.frame(time=sort(unique(time)), id=-1), re.form=NA, allow.new.levels=TRUE)
}
plot(ff2[,1], ff2[,2], type="b", xlab="time-point", ylab="mean of the latent variable of the Y-variables", ylim=c(min(ff2[,2],ff6),max(ff2[,2],ff6)))
lines(sort(unique(time)), ff6, col=3, lwd=2)
title("estimated change of the mean of the latent variables with time", sub = paste0("sparsity levels (", nonz[1], ", ", nonz[2], ")"), outer=T, line=-3, adj = 0.95)
# cor_nz_b_gen[,i]  <<- sapply(1:nrow(cor_nz_b_gen), function(t) cor(theta[,t], ff6[t]))
}
}
scalar1 <- function(x) {x / sqrt(sum(x^2))}
scalar1 <- function(x) {x / sqrt(sum(x^2))}
X0 = df_rna_stress_t0[df_rna_stress_t0$id %in% info_hmp[info_hmp$Class %in% c("Prediabetic", "Crossover"), ]$SubjectID,-c(1, 3, 4, ncol(df_rna_stress_t0))]
colnames(X0)[1:2] <-c("id", "time")
Y0 = df_mic_stress_t0[df_mic_stress_t0$id %in% info_hmp[info_hmp$Class %in% c("Prediabetic", "Crossover"), ]$SubjectID,-c(1, 3, 4,ncol(df_mic_stress_t0))]
colnames(Y0)[1:2] <-c("id", "time")
# scale and divide data
X0 = scale_rm(X0)
# scale and divide data
X0 = scale_rm(X0)
for (level in level_str) {
Y.temp = data.frame(id = Y0$id, time = Y0$time, Y0[,grep(level, names(Y0))])
assign(paste0("Y_", substr(level, 1, 3)), scale_rm(Y.temp)); rm(Y.temp)
}
for (level in level_str) {
if(level == "phylum_") K = 2
# canonical vectors
cv.temp = matrix(NA, nrow = ncol(X0)-2, ncol = K)
cv.temp = sapply(1:K, function(k) cbind(mod_stress_predDB[[level]][[k]]$alpha[,1]))
rownames(cv.temp) <- colnames(X0[,-c(1,2)])
assign(paste0("alpha_predDB_", substr(level, 1, 3)), cv.temp)
cv.temp = matrix(NA, nrow = ncol(get(paste0("Y_", substr(level, 1, 3))))-2, ncol = K)
cv.temp = sapply(1:K, function(k) cbind(mod_stress_predDB[[level]][[k]]$beta[,1]))
rownames(cv.temp) <- colnames(get(paste0("Y_", substr(level, 1, 3)))[,-c(1,2)])
assign(paste0("beta_predDB_", substr(level, 1, 3)), cv.temp); rm(cv.temp)
# latent variables
lv.temp = sapply(1:K, function(k) as.matrix(X0[,-c(1,2)]) %*% get(paste0("alpha_predDB_", substr(level, 1, 3)))[,k]); colnames(lv.temp) <- paste0("K",1:K)
df.temp = data.frame(id = X0$id, time = X0$time, lv.temp)
assign(paste0("lv_a_predDB_", substr(level, 1, 3)), df.temp); rm(lv.temp); rm(df.temp)
lv.temp = sapply(1:K, function(k) as.matrix(get(paste0("Y_", substr(level,1,3)))[,-c(1,2)]) %*% get(paste0("beta_predDB_", substr(level, 1, 3)))[,k]); colnames(lv.temp) <- paste0("K",1:K)
df.temp =  data.frame(id = (get(paste0("Y_", substr(level, 1, 3))))$id, time = (get(paste0("Y_", substr(level, 1, 3))))$time, lv.temp)
assign(paste0("lv_b_predDB_", substr(level, 1, 3)), df.temp); rm(lv.temp); rm(df.temp)
}
par(mfrow=c(1,2))
for (level in level_str) {
# dev.new(
lv = get(paste0("lv_a_", type, "_", substr(level, 1, 3)))
lv$K1 = scale_rm(lv[,c("id", "time", "K1")], centre = T)$K1; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K1 = lvplot$K1), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p1 = plot_ly(lvplot, x = ~time, y = ~K1, color = ~Class, type = 'scatter',mode = 'markers+lines', split = ~id) %>%
layout(
title = paste0("RNA latent path for K1"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K1")
)
)
lv = get(paste0("lv_b_", type, "_", substr(level, 1, 3)))
lv$K1 = scale_rm(lv[,c("id", "time", "K1")], centre = T)$K1; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K1 = lvplot$K1), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p2 = plot_ly(lvplot, x = ~time, y = ~K1, color = ~Class, type = 'scatter', mode = 'markers+lines', split = ~id) %>%
layout(
title =  paste0("Latent paths for K1"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K1")
)
)
assign(paste0("plot_lv_a_", substr(level, 1, 3)), p1); rm(p1)
assign(paste0("plot_lv_b_", substr(level, 1, 3)), p2); rm(p2)
}
#
# subplot(style(plot_lv_a_gen, showlegend = F), plot_lv_b_gen)
# subplot(style(plot_lv_a_fam, showlegend = F), plot_lv_b_fam)
# subplot(style(plot_lv_a_ord, showlegend = F), plot_lv_b_ord)
# subplot(style(plot_lv_a_cla, showlegend = F), plot_lv_b_cla)
# subplot(style(plot_lv_a_phy, showlegend = F), plot_lv_b_phy)
plot_all_k1 = subplot(style(plot_lv_a_gen, showlegend = F), style(plot_lv_b_gen, showlegend = F),
style(plot_lv_a_fam, showlegend = F), style(plot_lv_b_fam, showlegend = F),
style(plot_lv_a_ord, showlegend = F), style(plot_lv_b_ord, showlegend = F),
style(plot_lv_a_cla, showlegend = F), style(plot_lv_b_cla, showlegend = F),
style(plot_lv_a_phy, showlegend = F), style(plot_lv_b_phy, showlegend = T), nrows = 5)
plot_all_k1 <- plot_all_k1 %>% layout(
annotations = list(
list(x = 0.1, y = 1.02, text = "RNA - genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 1.02, text = "Gut  -genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.82, text = "RNA - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.82, text = "Gut - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.62, text = "RNA - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.62, text = "Gut - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.42, text = "RNA - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.42, text = "Gut - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.22, text = "RNA - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.22, text = "Gut - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper')
)
)
for (level in level_str[1:4]) {
# dev.new(
lv = get(paste0("lv_a_", type, "_", substr(level, 1, 3)))
lv$K2 = scale_rm(lv[,c("id", "time", "K2")], centre = T)$K2; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K2 = lvplot$K2), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p1 = plot_ly(lvplot, x = ~time, y = ~K2, color = ~Class, type = 'scatter',mode = 'markers+lines', split = ~id) %>%
layout(
title = paste0("RNA latent path for K2"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K2")
)
)
lv = get(paste0("lv_b_", type, "_", substr(level, 1, 3)))
lv$K2 = scale(lv$K2) #scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2; # lv$K2 = scale_rm(lv[,c("id", "time", "K2")], origin = 1, centre = T)$K2
lvplot = merge(lv, info_hmp[,c(1,7)], by.x = "id", by.y = "SubjectID"); #lvplot = lvplot[lvplot$Class %in% c("Prediabetic", "Control"),]
lvplot <- aggregate(list(K2 = lvplot$K2), by = list(time =lvplot$time, Class=lvplot$Class), FUN = mean)
p2 = plot_ly(lvplot, x = ~time, y = ~K2, color = ~Class, type = 'scatter', mode = 'markers+lines', split = ~id) %>%
layout(
title =  paste0("Latent paths for K2"),
scene = list(
xaxis = list(title = "Time"),
yaxis = list(title = "K2")
)
)
assign(paste0("plot_lv_a_", substr(level, 1, 3)), p1); rm(p1)
assign(paste0("plot_lv_b_", substr(level, 1, 3)), p2); rm(p2)
}
#
# subplot(style(plot_lv_a_gen, showlegend = F), plot_lv_b_gen)
# subplot(style(plot_lv_a_fam, showlegend = F), plot_lv_b_fam)
# subplot(style(plot_lv_a_ord, showlegend = F), plot_lv_b_ord)
# subplot(style(plot_lv_a_cla, showlegend = F), plot_lv_b_cla)
# subplot(style(plot_lv_a_phy, showlegend = F), plot_lv_b_phy)
plot_all_k2 = subplot(style(plot_lv_a_gen, showlegend = F), style(plot_lv_b_gen, showlegend = F),
style(plot_lv_a_fam, showlegend = F), style(plot_lv_b_fam, showlegend = F),
style(plot_lv_a_ord, showlegend = F), style(plot_lv_b_ord, showlegend = F),
style(plot_lv_a_cla, showlegend = F), style(plot_lv_b_cla, showlegend = T), nrows = 4)
plot_all_k2 <- plot_all_k2 %>% layout(
annotations = list(
list(x = 0.1, y = 1.02, text = "RNA - genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 1.02, text = "Gut  -genus", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.82, text = "RNA - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.82, text = "Gut - family", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.62, text = "RNA - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.62, text = "Gut - order", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.42, text = "RNA - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.42, text = "Gut - class", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.1, y = 0.22, text = "RNA - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper'),
list(x = 0.9, y = 0.22, text = "Gut - phylum", showarrow = FALSE, xref = 'paper', yref = 'paper')
)
)
plot_all_k1; plot_all_k2
plot_lv_b_phy
